import os
import re
import pandas as pd

def extract_CLM_DX_codes(directory):
    CLM_block_pattern = r'(CLM\*[^~]+~(?:[^~]*~)*?)(?=CLM\*|$)'  # Extract blocks starting with CLM to next CLM or end
    DX_pattern = r'HI\*([A-Z]{3}):([^*~]+)'

    data = []

    for filename in os.listdir(directory):
        if filename.lower().endswith('.edi'):
            file_path = os.path.join(directory, filename)
            with open(file_path, 'r') as file:
                edi_content = file.read()

                # Extract all CLM blocks
                CLM_blocks = re.findall(CLM_block_pattern, edi_content)

                for block in CLM_blocks:
                    # Extract the first CLM* line
                    CLM_match = re.search(r'CLM\*[^*]+\*', block)
                    if not CLM_match:
                        continue
                    CLM_code = CLM_match.group()

                    # Extract all HI diagnosis codes from the same block
                    DX_matches = re.findall(DX_pattern, block)

                    for segment, code in DX_matches:
                        if segment in ('ABK', 'ABN', 'ABF', 'APR', 'ABI'):
                            data.append({
                                'filename': filename,
                                'CLM_code': CLM_code,
                                'DX_code': code
                            })

    df = pd.DataFrame(data)
    return df

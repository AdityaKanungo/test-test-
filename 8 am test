import pandas as pd
from lifelines import KaplanMeierFitter
import matplotlib.pyplot as plt

STUDY_START = pd.to_datetime("2023-10-01")
STUDY_END   = pd.to_datetime("2025-09-30")

df['referral_received_date'] = pd.to_datetime(df['referral_received_date'])

results = []

for pid, g in df.groupby("long_person_id"):

    g = g.sort_values("referral_received_date")

    # ---- Find the index referral ----
    idx = g[g["is_index"] == "Y"]
    if idx.empty:
        continue

    index_date = idx.iloc[0]["referral_received_date"]

    # ignore if index is BEFORE study start (rare)
    if index_date < STUDY_START:
        index_date = STUDY_START

    # ---- Find first CPS referral after index ----
    cps = g[
        (g["referral_type"] == "CPS")
        & (g["referral_received_date"] > index_date)
    ]

    if cps.empty:
        # ---- No CPS during window → censored ----
        # censor at study end (not last GPS date!)
        time = (STUDY_END - index_date).days
        event = 0

    else:
        first_cps = cps.iloc[0]["referral_received_date"]
        # event must also fall inside the study window
        if first_cps <= STUDY_END:
            time = (first_cps - index_date).days
            event = 1
        else:
            # CPS after study end → censored
            time = (STUDY_END - index_date).days
            event = 0

    results.append({
        "long_person_id": pid,
        "time": time,
        "event": event
    })

surv_df = pd.DataFrame(results)

# ---- Fit KM Model ----
kmf = KaplanMeierFitter()
kmf.fit(surv_df["time"], surv_df["event"])

kmf.plot()
plt.title("Survival: Index GPS → First CPS (Observation Window)")
plt.xlabel("Days Since Index")
plt.ylabel("Survival Probability")
plt.show()

print("Median Time to CPS:", kmf.median_survival_time_)

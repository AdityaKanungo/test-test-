import pandas as pd
from lifelines import KaplanMeierFitter
import matplotlib.pyplot as plt

# ---------------------------------------------------------
# STEP 1: Prepare the dataset
# ---------------------------------------------------------

df['referral_received_date'] = pd.to_datetime(df['referral_received_date'])

# Ensure index referral is unique
index_df = df[df['is_index'] == 'Y'].copy()

results = []

for pid, group in df.groupby('long_person_id'):
    g = group.sort_values('referral_received_date')
    
    # Find index referral
    idx = g[g['is_index'] == 'Y']
    if idx.empty:
        continue

    index_date = idx.iloc[0]['referral_received_date']

    # Find FIRST CPS after index
    cps = g[(g['referral_type'] == 'CPS') &
            (g['referral_received_date'] > index_date)]

    if cps.empty:
        # --- Censored ---
        # time = last known referral date minus index date
        last_date = g['referral_received_date'].max()
        time = (last_date - index_date).days
        event = 0
    else:
        # --- Event occurred ---
        first_cps = cps.iloc[0]['referral_received_date']
        time = (first_cps - index_date).days
        event = 1

    results.append({
        'long_person_id': pid,
        'time': time,
        'event': event
    })

surv_df = pd.DataFrame(results)

# ---------------------------------------------------------
# STEP 2: Fit Kaplan-Meier Survival Curve
# ---------------------------------------------------------
kmf = KaplanMeierFitter()
kmf.fit(durations=surv_df['time'], event_observed=surv_df['event'])

kmf.plot()
plt.title("Survival from Index GPS to First CPS Referral")
plt.xlabel("Days since Index Referral")
plt.ylabel("Survival Probability (No CPS yet)")
plt.show()

# ---------------------------------------------------------
# STEP 3: Summary Stats
# ---------------------------------------------------------
print("Median time to CPS:", kmf.median_survival_time_)
print(kmf.survival_function_.head())
